<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Steuerung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      padding: 16px;
    }
    h1 {
      margin-top: 0;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    input, button, textarea {
      font-family: inherit;
      font-size: 16px;
    }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 4px 0 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      padding: 8px 12px;
      border-radius: 4px;
      border: none;
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      margin-right: 8px;
    }
    button.secondary {
      background: #777;
    }
    button:disabled {
      background: #bbb;
      cursor: default;
    }
    #status {
      font-size: 14px;
      color: #555;
      margin-top: 4px;
    }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

<h1>Steuerung</h1>

<div class="card">
  <h2>Verbindung</h2>
  <label>Display-ID</label>
  <input id="displayIdInput" value="kirche-beamer-1">

  <label>Pairing-Code von der Anzeige</label>
  <input id="codeInput" placeholder="z.B. 48291">

  <button id="pairBtn" onclick="pair()">Verbinden</button>
  <button class="secondary" onclick="clearToken()">Token löschen</button>

  <div id="status">Nicht verbunden</div>
</div>

<div class="card">
  <h2>Aktionen</h2>
  <button onclick="sendAction('prev')" id="btnPrev" disabled>◀︎ Zurück</button>
  <button onclick="sendAction('next')" id="btnNext" disabled>▶︎ Weiter</button>
  <button onclick="sendAction('resetPairing')" id="btnReset" class="secondary" disabled>Pairing zurücksetzen</button>
</div>

<div class="card">
  <h2>Text anzeigen</h2>
  <textarea id="textInput" rows="3" placeholder="Text für die Anzeige"></textarea>
  <button onclick="sendShowText()" id="btnShowText" disabled>Text senden</button>
</div>

<script>
  // TODO: Deine Firebase-Konfiguration hier eintragen
  const firebaseConfig = {
    apiKey: "AIzaSyDPZF_SoHChy3efmhlC4vGcdT62zYzKhsA",
    authDomain: "liedanzeige-3b1dc.firebaseapp.com",
    databaseURL: "https://liedanzeige-3b1dc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "liedanzeige-3b1dc",
    storageBucket: "liedanzeige-3b1dc.firebasestorage.app",
    messagingSenderId: "615806685064",
    appId: "1:615806685064:web:7c4e2d7403fe4a813d743d"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const displayIdInput = document.getElementById("displayIdInput");
  const codeInput = document.getElementById("codeInput");
  const statusEl = document.getElementById("status");

  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const btnReset = document.getElementById("btnReset");
  const btnShowText = document.getElementById("btnShowText");

  let controlToken = null;
  let currentDisplayId = displayIdInput.value;

  // Token aus localStorage laden (pro Browser)
  function loadToken() {
    currentDisplayId = displayIdInput.value.trim();
    const stored = localStorage.getItem("controlToken_" + currentDisplayId);
    if (stored) {
      controlToken = stored;
      setConnectedUI(true, "Mit Display '" + currentDisplayId + "' verbunden (Token vorhanden)");
    } else {
      controlToken = null;
      setConnectedUI(false, "Nicht verbunden");
    }
  }

  function setConnectedUI(connected, text) {
    statusEl.textContent = text || (connected ? "Verbunden" : "Nicht verbunden");
    btnPrev.disabled = !connected;
    btnNext.disabled = !connected;
    btnReset.disabled = !connected;
    btnShowText.disabled = !connected;
  }

  loadToken();

  // Pairing
  function pair() {
    const displayId = displayIdInput.value.trim();
    const enteredCode = codeInput.value.trim();

    if (!displayId || !enteredCode) {
      alert("Bitte Display-ID und Pairing-Code eingeben.");
      return;
    }

    db.ref(`displays/${displayId}/pairingCode`).once("value").then(snap => {
      const storedCode = snap.val();
      if (!storedCode) {
        alert("Für dieses Display ist kein Pairing-Code gesetzt.");
        return;
      }
      if (storedCode !== enteredCode) {
        alert("Falscher Pairing-Code.");
        return;
      }

      // gültig → Token erzeugen
      const token = (self.crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + "-" + Math.random());
      controlToken = token;
      currentDisplayId = displayId;

      // Token speichern
      db.ref(`displays/${displayId}/token`).set(token);
      localStorage.setItem("controlToken_" + displayId, token);

      setConnectedUI(true, "Mit Display '" + displayId + "' verbunden.");
      alert("Erfolgreich verbunden.");
    }).catch(err => {
      console.error(err);
      alert("Fehler beim Pairing.");
    });
  }

  function clearToken() {
    const displayId = displayIdInput.value.trim();
    if (!displayId) return;
    localStorage.removeItem("controlToken_" + displayId);
    controlToken = null;
    setConnectedUI(false, "Token gelöscht. Nicht verbunden.");
  }

  // Aktionen senden
  function sendAction(action, payload) {
    if (!controlToken) {
      alert("Nicht verbunden. Bitte zuerst pairen.");
      return;
    }
    const displayId = displayIdInput.value.trim();
    const ref = db.ref(`displays/${displayId}/control`);
    ref.set({
      action: action,
      payload: payload || null,
      token: controlToken,
      ts: Date.now()
    });
  }

  function sendShowText() {
    const text = document.getElementById("textInput").value;
    sendAction("showText", text);
  }

  // Wenn Display-ID geändert wird, Token neu laden
  displayIdInput.addEventListener("change", loadToken);
</script>

</body>
</html>